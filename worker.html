<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Production Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            padding: 20px; 
            background-color: #f4f7f9; 
            color: #333;
            min-height: 100vh;
        }
        .main-container {
            max-width: 1600px; 
            margin: auto; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* --- CHANGE 1: ENLARGED AND CENTERED TITLE --- */
        h1 { 
            color: #1F2937; 
            text-align: center; 
            border-bottom: 3px solid #3B82F6; 
            padding-bottom: 10px; 
            margin-bottom: 15px; 
            width: 100%; 
            font-size: 3rem; 
            font-weight: 900; 
        }
        
        .card { 
            background-color: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            width: 100%;
        }
        
        /* --- CHANGE 2: CENTERED ALL CARD TITLES (H2) --- */
        .card h2 {
            text-align: center;
        }
        
        /* Reduced Vertical Spacing and Smaller Labels for Compactness */
        label { display: block; margin-top: 5px; font-weight: 600; color: #4B5563; font-size: 0.85rem; }
        
        /* Reduced Input Padding */
        input:not(#produced-qty):not(#produced-length):not(#qty-produced-hours), select { 
            width: 100%; 
            padding: 7px; 
            margin-bottom: 5px; 
            box-sizing: border-box; 
            border-radius: 6px; 
            border: 1px solid #D1D5DB; 
            font-size: 14px; 
            transition: all 0.2s ease-in-out, box-shadow 0.2s ease-in-out; 
        }
        
        input:focus, select:focus { 
            border-color: #3B82F6; 
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); 
        }
        
        /* === NEW: Readonly Style === */
        input[readonly] {
            background-color: #E5E7EB; /* Gray-200 to show it's disabled/autofilled */
            cursor: default;
            color: #4B5563; /* Gray-600 */
        }

        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn-group button { 
            flex: 1; 
            padding: 10px; 
            font-weight: bold; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: background-color 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        #submit-button { background-color: #10B981; color: white; }
        #submit-button:hover { background-color: #059669; box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);}
        #reset-button { background-color: #EF4444; color: white; }
        #reset-button:hover { background-color: #DC2626; box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);}
        .message { text-align: center; font-weight: bold; margin-top: 15px; padding: 8px; border-radius: 4px; font-size: 0.9rem; }
        
        /* Default 2-column input row for general fields */
        .input-row { display: flex; gap: 10px; margin-bottom: 5px; }
        .input-row > div { flex: 1; } 
        
        /* === Qty/Length/Hours Specific Style (Kept as 3-col) === */
        .input-row-qty { 
            margin-top: 15px; 
            margin-bottom: 10px; 
        }

        .input-row-qty > div > input {
            min-width: 100px; 
            font-size: 1.0rem; 
            padding: 10px 8px; 
            text-align: center; 
            font-weight: 700; 
            background-color: #EFFBEB; 
            border-color: #34D399; 
            transition: all 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-row-qty label {
            text-align: center;
            font-size: 0.85rem;
            color: #065F46; 
            font-weight: 700;
        }
        
        /* === Plan Sheet Styles (Simplified and Compact) === */
        #plan-sheet-container { 
            border: 2px solid #3B82F6; 
            border-radius: 8px; 
            padding: 15px;
            background-color: #EFF6FF;
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            flex-grow: 1; 
            max-height: 100%;
        }
        #plan-data-view {
            flex-grow: 1; 
            overflow-y: auto; 
            margin-top: 10px;
        }

        /* === Plan Sheet Table and Button Styles (IMPROVED) === */
        #plan-sheet-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        #plan-sheet-table th, #plan-sheet-table td {
            padding: 8px 6px;
            text-align: left;
            border-bottom: 1px solid #E5E7EB;
            white-space: nowrap; /* Prevent wrapping in cells */
        }
        #plan-sheet-table th {
            background-color: #DBEAFE; /* Blue-100 */
            color: #1E40AF; /* Blue-800 */
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .plan-completed {
            background-color: #ECFDF5; /* Green-50 */
            color: #065F46; /* Green-800 */
            opacity: 0.7;
        }
        .plan-completed td {
            text-decoration: line-through;
        }

        .complete-button {
            padding: 6px 12px;
            font-weight: 600;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 0.8rem;
            cursor: pointer;
            min-width: 100px; /* Uniform width */
        }

        .complete-button-pending {
            background-color: #3B82F6; /* Blue-600 */
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }
        .complete-button-pending:hover {
            background-color: #2563EB; /* Blue-700 */
        }
        .complete-button-completed {
            background-color: #10B981; /* Green-500 */
            color: white;
            opacity: 0.5;
            cursor: default;
        }
        .plan-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1D4ED8; /* Blue-700 */
            padding-bottom: 8px;
            border-bottom: 2px solid #BFDBFE; /* Blue-200 */
        }
        
        /* === Terminal Box Styles (NEW) === */
        .terminal-box {
            border: 1px solid #D1D5DB; 
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            background-color: #F9FAFB;
        }

        /* === Style for Title and Inline Terminal ID Input - CENTERED === */
        .title-and-id-row {
            display: flex;
            align-items: flex-end; 
            gap: 10px;
            width: fit-content; 
            /* Adjusted margin to look good inside the new box */
            margin: 5px auto 10px auto; 
            border-bottom: 1px solid #E5E7EB; 
            padding-bottom: 5px;
        }
        .title-and-id-row h3 {
            font-size: 1.0rem; 
            font-weight: 700;
            color: #1F2937;
            margin: 0; 
            padding: 0;
            flex-shrink: 0; 
            line-height: 1.25rem; 
        }
        .title-and-id-row .terminal-id-input-group {
            flex-grow: 0; 
            width: 180px; 
        }
        /* Hide the label for the inline ID input */
        .title-and-id-row .terminal-id-input-group label {
            display: none; 
        }
        /* Ensure the ID input itself looks right */
        .title-and-id-row .terminal-id-input-group input {
            margin-bottom: 0;
            padding: 5px 7px; 
        }


        /* === Crimp Data specific styling - Full Width === */
        /* Updated for 8 columns (4 parameters * 2 inputs) */
        .input-row-8col { 
            display: grid; 
            grid-template-columns: repeat(8, 1fr); 
            gap: 10px; 
            margin-bottom: 5px;
        }
        /* New class for pull force row (2 inputs + 2 spacers) */
        .input-row-pull-force { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px; 
            margin-bottom: 10px;
        }
        .input-row-8col > div, .input-row-pull-force > div { 
            margin-bottom: 0;
        }

        /* === CONNECTION STATUS STYLING === */
        #connection-card {
            padding: 10px 15px; 
        }
        
        #connection-card .input-row.items-end {
            max-width: 400px; 
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 5px;
        }
        
        #room-status {
            text-align: center;
        }
        
        /* === Main Layout Grid === */
        .main-content-grid {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 20px; 
            width: 100%;
            align-items: flex-start;
        }
        @media (min-width: 1200px) { 
            .main-content-grid {
                grid-template-columns: 1.5fr 1.5fr; 
                max-height: calc(100vh - 40px); 
            }
        }
        .data-entry-container {
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }
        
        #join-room-button {
             padding-top: 8px;
             padding-bottom: 8px;
        }
        .submission-card {
            padding-top: 15px;
        }
        
        /* ============================================== */
        /* === FIX: NEW LIVE MESSAGE TOAST STYLES === */
        /* ============================================== */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3B82F6; /* Blue-600 */
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            width: 300px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateX(100%);
            /* Springy transition to make it look professional */
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border-left: 5px solid #60A5FA; /* Blue-400 */
        }
        
        #toast-container.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>Production Data</h1>
        
        <div class="main-content-grid">
            
            <div class="data-entry-container">
                
                <div id="connection-card" class="card bg-indigo-50 border border-indigo-200">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">Connection Status</h2>
                    <div class="input-row items-end">
                        <div style="flex-grow: 2;">
                            <label for="machine-name-input">My Machine Name:</label>
                            <select id="machine-name-input" required class="uppercase">
                                <option value="" disabled selected>Select Machine</option>
                                <option value="AUM-002">AUM-002</option>
                                <option value="AUM-003">AUM-003</option>
                                <option value="AUM-009">AUM-009</option>
                                <option value="AUM-001">AUM-001</option>
                                <option value="AUM-010">AUM-010</option>
                                <option value="AUM-005">AUM-005</option>
                                <option value="AUM-011">AUM-011</option>
                                <option value="AUM-012">AUM-012</option>
                            </select>
                        </div>
                        <div style="flex-grow: 1;"> 
                            <button onclick="joinMachineRoom()" id="join-room-button" class="w-full bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                                Connect
                            </button>
                        </div>
                    </div>
                    <p id="room-status" class="text-xs mt-1 font-medium text-indigo-700">Not connected to a machine room.</p>
                </div>

                <div class="card bg-gray-100 border border-gray-300 p-4 mb-2">
                    <p class="text-sm font-semibold text-gray-700 mb-2 text-center">Load Measured Data Reference</p>
                    <div class="input-row justify-center">
                        <button id="excel-upload-button" onclick="openExcelFileSelector()" class="bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md p-2 flex items-center justify-center gap-2 w-full max-w-sm mx-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                            Load Check Sheet
                        </button>
                        <input type="file" id="excel-file-input" accept=".xlsx, .xls" style="display: none;" onchange="handleExcelUpload(event)">
                    </div>
                </div>
                <div class="card submission-card">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">Submit Production Output</h2>

                    <div class="input-row">
                        <div>
                            <label for="entry-date">Date:</label>
                            <input type="date" id="entry-date" required>
                        </div>
                        <div>
                            <label for="entry-time">Time:</label>
                            <input type="time" id="entry-time" required>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <div>
                            <label for="shift">Shift:</label>
                            <select id="shift" required>
                                <option value="" disabled selected>Select Shift</option>
                                <option value="A">Shift A</option>
                                <option value="B">Shift B</option>
                                <option value="C">Shift C</option>
                            </select>
                        </div>
                        <div>
                            <label for="operator-name">Operator Name:</label>
                            <input type="text" id="operator-name" placeholder="Enter name" required>
                        </div>
                    </div>

                    <div class="input-row">
                        <div>
                            <label for="fg-part-no">FG Part No:</label>
                            <input type="text" id="fg-part-no" placeholder="e.g., P-789" required oninput="autofillMeasuredData()">
                        </div>
                        <div>
                            <label for="cable-id">Cable ID:</label>
                            <input type="text" id="cable-id" placeholder="e.g., 12" required oninput="autofillMeasuredData()">
                        </div>
                    </div>

                    <input type="hidden" id="machine-name" value="" required> 
                    
                    <div class="terminal-box">
                        <div class="title-and-id-row">
                            <h3>Terminal 1</h3>
                            <div class="terminal-id-input-group">
                                <label for="t1-terminal-id">Terminal Part Number:</label>
                                <input type="text" id="t1-terminal-id" placeholder="Enter Terminal Part Number">
                            </div>
                            <div class="terminal-id-input-group">
                                <label for="t1-apl-no">APL NO:</label>
                                <input type="text" id="t1-apl-no" placeholder="Enter APL NO:">
                            </div>
                        </div>
                            
                        <div class="input-row-8col">
                            <div>
                                <label for="t1-crimp-height-measured">Crimp H (mm) Meas:</label>
                                <input type="number" step="0.01" id="t1-crimp-height-measured" placeholder="1.25" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t1-crimp-height-manual">Crimp H (mm) Man:</label>
                                <input type="number" step="0.01" id="t1-crimp-height-manual" placeholder="1.25">
                            </div>
                            
                            <div>
                                <label for="t1-insulation-height-measured">Insulation H (mm) Meas:</label>
                                <input type="number" step="0.01" id="t1-insulation-height-measured" placeholder="3.40" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t1-insulation-height-manual">Insulation H (mm) Man:</label>
                                <input type="number" step="0.01" id="t1-insulation-height-manual" placeholder="3.40">
                            </div>
                            
                            <div>
                                <label for="t1-crimp-width-measured">Crimp W (mm) Meas:</label>
                                <input type="number" step="0.01" id="t1-crimp-width-measured" placeholder="2.30" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t1-crimp-width-manual">Crimp W (mm) Man:</label>
                                <input type="number" step="0.01" id="t1-crimp-width-manual" placeholder="2.30">
                            </div>
                            
                            <div>
                                <label for="t1-insulation-width-measured">Insulation W (mm) Meas:</label>
                                <input type="number" step="0.01" id="t1-insulation-width-measured" placeholder="4.50" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t1-insulation-width-manual">Insulation W (mm) Man:</label>
                                <input type="number" step="0.01" id="t1-insulation-width-manual" placeholder="4.50">
                            </div>
                        </div>
                            
                        <div class="input-row-pull-force">
                            <div>
                                <label for="t1-pull-force-measured">Pull Force (N) Meas:</label>
                                <input type="number" step="0.1" id="t1-pull-force-measured" placeholder="120.5" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t1-pull-force-manual">Pull Force (N) Man:</label>
                                <input type="number" step="0.1" id="t1-pull-force-manual" placeholder="120.5">
                            </div>
                            <div></div> 
                            <div></div> 
                        </div>
                    </div>
                    <div class="terminal-box">
                        <div class="title-and-id-row">
                            <h3>Terminal 2</h3>
                            <div class="terminal-id-input-group">
                                <label for="t2-terminal-id">Terminal Part Number:</label>
                                <input type="text" id="t2-terminal-id" placeholder="Enter Terminal Part Number">
                            </div>
                            <div class="terminal-id-input-group">
                                <label for="t2-apl-no">APL NO:</label>
                                <input type="text" id="t2-apl-no" placeholder="Enter APL NO:">
                            </div>
                        </div>
                            
                        <div class="input-row-8col">
                            <div>
                                <label for="t2-crimp-height-measured">Crimp H (mm) Meas:</label>
                                <input type="number" step="0.01" id="t2-crimp-height-measured" placeholder="1.25" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t2-crimp-height-manual">Crimp H (mm) Man:</label>
                                <input type="number" step="0.01" id="t2-crimp-height-manual" placeholder="1.25">
                            </div>
                            
                            <div>
                                <label for="t2-insulation-height-measured">Insulation H (mm) Meas:</label>
                                <input type="number" step="0.01" id="t2-insulation-height-measured" placeholder="3.40" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t2-insulation-height-manual">Insulation H (mm) Man:</label>
                                <input type="number" step="0.01" id="t2-insulation-height-manual" placeholder="3.40">
                            </div>
                            
                            <div>
                                <label for="t2-crimp-width-measured">Crimp W (mm) Meas:</label>
                                <input type="number" step="0.01" id="t2-crimp-width-measured" placeholder="2.30" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t2-crimp-width-manual">Crimp W (mm) Man:</label>
                                <input type="number" step="0.01" id="t2-crimp-width-manual" placeholder="2.30">
                            </div>
                            
                            <div>
                                <label for="t2-insulation-width-measured">Insulation W (mm) Meas:</label>
                                <input type="number" step="0.01" id="t2-insulation-width-measured" placeholder="4.50" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t2-insulation-width-manual">Insulation W (mm) Man:</label>
                                <input type="number" step="0.01" id="t2-insulation-width-manual" placeholder="4.50">
                            </div>
                        </div>
                            
                        <div class="input-row-pull-force">
                            <div>
                                <label for="t2-pull-force-measured">Pull Force (N) Meas:</label>
                                <input type="number" step="0.1" id="t2-pull-force-measured" placeholder="120.5" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t2-pull-force-manual">Pull Force (N) Man:</label>
                                <input type="number" step="0.1" id="t2-pull-force-manual" placeholder="120.5">
                            </div>
                            <div></div> 
                            <div></div> 
                        </div>
                    </div>
                    <div class="input-row input-row-qty">
                        <div>
                            <label for="produced-qty">Produced Qty:</label>
                            <input type="number" id="produced-qty" required min="1">
                        </div>
                        <div>
                            <label for="produced-length">Length (M/F):</label>
                            <input type="number" step="0.1" id="produced-length" required min="0.1">
                        </div>
                        <div>
                            <label for="qty-produced-hours">Hours:</label>
                            <input type="number" step="0.1" id="qty-produced-hours" required min="0.1">
                        </div>
                    </div>

                    <div class="btn-group">
                        <button id="submit-button" onclick="submitOutput()">Submit Data</button>
                        <button id="reset-button" onclick="resetForm()">Reset Fields</button>
                    </div>

                    <div id="message" class="message"></div>
                </div>
            </div> 
            
            <div id="plan-sheet-container" class="card">
                <div class="plan-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    <span class="text-lg">Active Plan Sheet:</span>
                    <span id="current-plan-machine" class="text-base font-normal">N/A</span>
                </div>
                <div id="plan-data-view">
                    <p class="text-gray-500 italic text-sm">Plan data will appear here after the dashboard assigns a sheet.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-box">
        <div class="flex justify-between items-center mb-1">
            <h2 class="text-sm font-semibold text-white flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                Live Message
            </h2>
            <button onclick="hideMessageBox()" class="text-white hover:text-gray-200 focus:outline-none -mt-1 -mr-1 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <p id="live-message-content" class="text-sm text-white font-medium"></p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        const machineNameInput = document.getElementById('machine-name-input');
        const machineNameHidden = document.getElementById('machine-name');
        const roomStatus = document.getElementById('room-status');
        const planDataView = document.getElementById('plan-data-view');
        const currentPlanMachine = document.getElementById('current-plan-machine');
        const connectionCard = document.getElementById('connection-card');
        const messageBox = document.getElementById('toast-container');
        const messageContent = document.getElementById('live-message-content');
        
        // GLOBAL LOOKUP TABLE for Excel Data
        let measuredDataLookup = [];

        function setInitialDateTime() {
            const now = new Date();
            const year = String(now.getFullYear());
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            document.getElementById('entry-date').value = `${year}-${month}-${day}`;
            document.getElementById('entry-time').value = `${hours}:${minutes}`;
        }
        
        document.addEventListener('DOMContentLoaded', setInitialDateTime);

        function joinMachineRoom() {
            const machineName = machineNameInput.value.toUpperCase();
            if (!machineName) {
                alert("Please select a Machine Name.");
                return;
            }
            machineNameHidden.value = machineName;
            
            machineNameInput.disabled = true;
            document.getElementById('join-room-button').disabled = true;
            roomStatus.textContent = `Connecting to room: ${machineName}...`;
            
            socket.emit('join_machine_room', { machineName: machineName });
        }
        
        function resetForm() {
            // Reset all input fields
            document.getElementById('shift').value = '';
            document.getElementById('operator-name').value = '';
            document.getElementById('fg-part-no').value = ''; 
            document.getElementById('cable-id').value = ''; 
            document.getElementById('produced-qty').value = '';
            document.getElementById('produced-length').value = '';
            document.getElementById('qty-produced-hours').value = '';
            
            // Reset Terminal 1 Fields (12 fields total)
            document.getElementById('t1-terminal-id').value = ''; 
            document.getElementById('t1-apl-no').value = ''; 
            document.getElementById('t1-crimp-height-measured').value = '';
            document.getElementById('t1-crimp-height-manual').value = '';
            document.getElementById('t1-insulation-height-measured').value = '';
            document.getElementById('t1-insulation-height-manual').value = '';
            document.getElementById('t1-crimp-width-measured').value = '';
            document.getElementById('t1-crimp-width-manual').value = '';
            document.getElementById('t1-insulation-width-measured').value = '';
            document.getElementById('t1-insulation-width-manual').value = '';
            document.getElementById('t1-pull-force-measured').value = '';
            document.getElementById('t1-pull-force-manual').value = '';

            // Reset Terminal 2 Fields (12 fields total)
            document.getElementById('t2-terminal-id').value = ''; 
            document.getElementById('t2-apl-no').value = '';
            document.getElementById('t2-crimp-height-measured').value = '';
            document.getElementById('t2-crimp-height-manual').value = '';
            document.getElementById('t2-insulation-height-measured').value = '';
            document.getElementById('t2-insulation-height-manual').value = '';
            document.getElementById('t2-crimp-width-measured').value = '';
            document.getElementById('t2-crimp-width-manual').value = '';
            document.getElementById('t2-insulation-width-measured').value = '';
            document.getElementById('t2-insulation-width-manual').value = '';
            document.getElementById('t2-pull-force-measured').value = '';
            document.getElementById('t2-pull-force-manual').value = '';

            document.getElementById('message').textContent = '';
            setInitialDateTime(); // Reset date/time to current
        }

        function markPlanLineComplete(lineId) {
            socket.emit('mark_plan_complete', { lineId: lineId, machineName: machineNameHidden.value });
        }
        
        // --- UPDATED Autofill Function ---
        function clearMeasuredFields() {
            const fieldsToClear = [
                // T1
                't1-terminal-id', 't1-apl-no',
                't1-crimp-height-measured', 't1-insulation-height-measured', 't1-crimp-width-measured', 
                't1-insulation-width-measured', 't1-pull-force-measured', 
                // T2
                't2-terminal-id', 't2-apl-no',
                't2-crimp-height-measured', 't2-insulation-height-measured', 't2-crimp-width-measured', 
                't2-insulation-width-measured', 't2-pull-force-measured'
            ];
            fieldsToClear.forEach(id => {
                document.getElementById(id).value = '';
            });
        }
        
        function autofillMeasuredData() {
            const fgPartNoInput = document.getElementById('fg-part-no').value.trim();
            const cableIdInput = document.getElementById('cable-id').value.trim();
            
            clearMeasuredFields(); // Always clear first
            
            if (!fgPartNoInput || !cableIdInput || measuredDataLookup.length === 0) {
                // Do not show an error if fields are just empty or data not loaded
                return;
            }
            
            // Search the loaded data
            const match = measuredDataLookup.find(row => 
                row.FG_PART_NO === fgPartNoInput && 
                row.CABLE_ID === cableIdInput
            );
            
            if (match) {
                // Terminal 1 Data
                document.getElementById('t1-terminal-id').value = match.T1_TERMINAL_ID || ''; 
                document.getElementById('t1-apl-no').value = match.T1_APL_NO || ''; 
                document.getElementById('t1-crimp-height-measured').value = match.T1_CRIMP_H || '';
                document.getElementById('t1-insulation-height-measured').value = match.T1_INSULATION_H || '';
                document.getElementById('t1-crimp-width-measured').value = match.T1_CRIMP_W || '';
                document.getElementById('t1-insulation-width-measured').value = match.T1_INSULATION_W || '';
                document.getElementById('t1-pull-force-measured').value = match.T1_PULL_FORCE || '';
                
                // Terminal 2 Data
                document.getElementById('t2-terminal-id').value = match.T2_TERMINAL_ID || ''; 
                document.getElementById('t2-apl-no').value = match.T2_APL_NO || ''; 
                document.getElementById('t2-crimp-height-measured').value = match.T2_CRIMP_H || '';
                document.getElementById('t2-insulation-height-measured').value = match.T2_INSULATION_H || '';
                document.getElementById('t2-crimp-width-measured').value = match.T2_CRIMP_W || '';
                document.getElementById('t2-insulation-width-measured').value = match.T2_INSULATION_W || '';
                document.getElementById('t2-pull-force-measured').value = match.T2_PULL_FORCE || '';

                showMessageBox(`Full reference data for ${fgPartNoInput} / ${cableIdInput} autofilled from check sheet.`, 'success');
            } else {
                
                // --- NEW DETAILED ERROR CHECKING ---
                let debugMessage = `No matching reference data found for ${fgPartNoInput} / ${cableIdInput}. `;
                
                // Check if FG_PART_NO exists at all
                const fgMatches = measuredDataLookup.filter(row => row.FG_PART_NO === fgPartNoInput);
                if (fgMatches.length > 0) {
                    debugMessage += `Found ${fgMatches.length} rows with matching FG Part No (${fgPartNoInput}). `;
                    
                    // Check if CABLE_ID matches in any of those rows
                    const cableIdsFound = fgMatches.map(row => `"${row.CABLE_ID}"`);
                    debugMessage += `However, CABLE_ID "${cableIdInput}" did not match any of these Cable IDs: ${cableIdsFound.join(', ')}.`;
                    debugMessage += ` (Check for hidden spaces or character mismatches in your Excel 'CABLE_ID' column, even if they look right.)`;
                } else {
                    // FG_PART_NO itself is the problem
                    debugMessage += `FG Part No "${fgPartNoInput}" was not found in the loaded sheet. (Check for hidden spaces or character mismatches in your Excel 'FG_PART_NO' column).`;
                }

                showMessageBox(debugMessage, 'warning');
            }
        }
        
        // --- FIXED: Excel Upload Functions (More robust string conversion) ---
        function openExcelFileSelector() {
            document.getElementById('excel-file-input').click();
        }

        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Use header: 1 to enforce reading the first row as headers. raw: true retains original cell values/types.
                    const workbook = XLSX.read(data, { type: 'array', cellStyles: true, raw: true }); 
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    // Convert the sheet data to JSON array
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        throw new Error('No data rows found. Ensure data starts on row 2 with headers on row 1.');
                    }
                    
                    // --- FIX IS HERE: Explicitly convert and store key fields as trimmed strings ---
                    measuredDataLookup = jsonData.map(row => {
                        const newRow = { ...row };
                        
                        // Ensure FG_PART_NO is a trimmed string
                        newRow.FG_PART_NO = String(newRow.FG_PART_NO || '').trim();
                        
                        // Ensure CABLE_ID is a trimmed string (crucial for matching '12' as a number in Excel to '12' as text in the form)
                        // This handles both numbers (12 -> "12") and text ("12") correctly.
                        newRow.CABLE_ID = String(newRow.CABLE_ID || '').trim();
                        
                        return newRow;
                    });
                    // --- END FIX ---


                    showMessageBox(`Successfully loaded ${measuredDataLookup.length} records from Check Sheet. Try entering an FG Part No and Cable ID.`, 'success');

                } catch (error) {
                    showMessageBox(`Error processing file: ${error.message}`, 'error');
                    measuredDataLookup = []; // Clear data on error
                } finally {
                    // Reset the file input so the same file can be selected again
                    event.target.value = '';
                    setTimeout(() => { document.getElementById('message').textContent = ''; }, 8000);
                }
            };

            reader.onerror = function() {
                showMessageBox('Error reading the file.', 'error');
                measuredDataLookup = [];
                setTimeout(() => { document.getElementById('message').textContent = ''; }, 5000);
            };

            reader.readAsArrayBuffer(file);
        }
        // --- END FIXED Excel Upload Functions ---


        function submitOutput() {
            const machineName = machineNameHidden.value;
            if (!machineName) {
                showMessageBox('Error: Please connect to a Machine Room first!', 'error');
                return;
            }
            
            // 1. Gather all data
            const data = {
                shift: document.getElementById('shift').value,
                operator_name: document.getElementById('operator-name').value, 
                machine_name: machineName,
                fg_part_no: document.getElementById('fg-part-no').value,
                cable_id: document.getElementById('cable-id').value,
                // These are required fields, validation is below
                produced_qty: parseInt(document.getElementById('produced-qty').value),
                produced_length: parseFloat(document.getElementById('produced-length').value),
                qty_produced_hours: parseFloat(document.getElementById('qty-produced-hours').value),
                entry_date: document.getElementById('entry-date').value, 
                entry_time: document.getElementById('entry-time').value,
                
                // Terminal 1 Data
                t1_terminal_id: document.getElementById('t1-terminal-id').value,
                t1_apl_no: document.getElementById('t1-apl-no').value, 
                t1_crimp_height_measured: parseFloat(document.getElementById('t1-crimp-height-measured').value),
                t1_crimp_height_manual: parseFloat(document.getElementById('t1-crimp-height-manual').value),
                t1_insulation_height_measured: parseFloat(document.getElementById('t1-insulation-height-measured').value),
                t1_insulation_height_manual: parseFloat(document.getElementById('t1-insulation-height-manual').value),
                t1_crimp_width_measured: parseFloat(document.getElementById('t1-crimp-width-measured').value),
                t1_crimp_width_manual: parseFloat(document.getElementById('t1-crimp-width-manual').value),
                t1_insulation_width_measured: parseFloat(document.getElementById('t1-insulation-width-measured').value),
                t1_insulation_width_manual: parseFloat(document.getElementById('t1-insulation-width-manual').value),
                t1_pull_force_measured: parseFloat(document.getElementById('t1-pull-force-measured').value),
                t1_pull_force_manual: parseFloat(document.getElementById('t1-pull-force-manual').value),
                
                // Terminal 2 Data
                t2_terminal_id: document.getElementById('t2-terminal-id').value,
                t2_apl_no: document.getElementById('t2-apl-no').value,
                t2_crimp_height_measured: parseFloat(document.getElementById('t2-crimp-height-measured').value),
                t2_crimp_height_manual: parseFloat(document.getElementById('t2-crimp-height-manual').value),
                t2_insulation_height_measured: parseFloat(document.getElementById('t2-insulation-height-measured').value),
                t2_insulation_height_manual: parseFloat(document.getElementById('t2-insulation-height-manual').value),
                t2_crimp_width_measured: parseFloat(document.getElementById('t2-crimp-width-measured').value),
                t2_crimp_width_manual: parseFloat(document.getElementById('t2-crimp-width-manual').value),
                t2_insulation_width_measured: parseFloat(document.getElementById('t2-insulation-width-measured').value),
                t2_insulation_width_manual: parseFloat(document.getElementById('t2-insulation-width-manual').value),
                t2_pull_force_measured: parseFloat(document.getElementById('t2-pull-force-measured').value),
                t2_pull_force_manual: parseFloat(document.getElementById('t2-pull-force-manual').value)
            };
            
            // 2. Simple validation (client-side checks for required fields only)
            if (!document.querySelector('#entry-date').checkValidity() || !document.querySelector('#entry-time').checkValidity() || !document.querySelector('#shift').checkValidity() || !document.querySelector('#operator-name').checkValidity() || !document.querySelector('#fg-part-no').checkValidity() || !document.querySelector('#cable-id').checkValidity()) {
                showMessageBox('Please fill in all general required fields.', 'error');
                return;
            }

            const qty = data.produced_qty;
            const length = data.produced_length;
            const hours = data.qty_produced_hours;

            if (isNaN(qty) || qty < 1) {
                 showMessageBox('Quantity must be a positive whole number.', 'error');
                 return;
            }
            if (isNaN(length) || length <= 0) {
                 showMessageBox('Length must be a positive number.', 'error');
                 return;
            }
            if (isNaN(hours) || hours <= 0) {
                 showMessageBox('Hours must be a positive number.', 'error');
                 return;
            }
            
            // Show submission message
            document.getElementById('message').textContent = 'Submitting data...';
            document.getElementById('message').style.backgroundColor = '#EFF6FF';
            document.getElementById('message').style.color = '#1E40AF';

            socket.emit('submit_output', data);

            // Clear submitted data fields for a new entry
            document.getElementById('fg-part-no').value = ''; 
            document.getElementById('cable-id').value = ''; 
            document.getElementById('produced-qty').value = '';
            document.getElementById('produced-length').value = '';
            document.getElementById('qty-produced-hours').value = '';
            
            // Clear all Terminal 1 & 2 fields (Measured and Manual)
            clearMeasuredFields(); 
            // Only need to clear Manual fields as clearMeasuredFields now handles Measured/Reference ones
            document.getElementById('t1-crimp-height-manual').value = '';
            document.getElementById('t1-insulation-height-manual').value = '';
            document.getElementById('t1-crimp-width-manual').value = '';
            document.getElementById('t1-insulation-width-manual').value = '';
            document.getElementById('t1-pull-force-manual').value = '';

            document.getElementById('t2-crimp-height-manual').value = '';
            document.getElementById('t2-insulation-height-manual').value = '';
            document.getElementById('t2-crimp-width-manual').value = '';
            document.getElementById('t2-crimp-width-manual').value = '';
            document.getElementById('t2-insulation-width-manual').value = '';
            document.getElementById('t2-pull-force-manual').value = '';
            
            document.getElementById('message').textContent = 'Output submitted successfully! Ready for next entry.';
            setTimeout(() => { document.getElementById('message').textContent = ''; }, 3000); 
        }

        // --- Socket.IO Event Handlers ---

        socket.on('join_confirm', (data) => {
            if (data.success) {
                roomStatus.textContent = `Connected to room: ${data.machineName}. Plan loaded.`;
                roomStatus.className = 'text-xs mt-1 font-bold text-green-700';
                connectionCard.style.backgroundColor = '#F0FFF4';
                connectionCard.style.borderColor = '#34D399';
            } else {
                roomStatus.textContent = `Error connecting: ${data.reason}`;
                roomStatus.className = 'text-xs mt-1 font-bold text-red-700';
                machineNameInput.disabled = false;
                document.getElementById('join-room-button').disabled = false;
            }
        });
        
        socket.on('update_worker_plan', (data) => {
            if (data.machineName === machineNameHidden.value) {
                displayPlanSheet(data.plan, data.machineName);
            }
        });

        socket.on('submission_success', (data) => {
             document.getElementById('message').textContent = 'Output submitted successfully!';
             setTimeout(() => {
                 document.getElementById('message').textContent = '';
             }, 3000);
        });
        
        // --- LIVE MESSAGE LISTENER ---
        socket.on('live_message', (data) => {
            showMessageBox(data.message, 'info');
        });

        // --- Plan Sheet Rendering ---
        function displayPlanSheet(plan, machineName) {
            currentPlanMachine.textContent = machineName;
            
            if (plan.length === 0) {
                planDataView.innerHTML = '<p class="text-gray-500 italic text-sm">No plan sheet assigned for this machine.</p>';
                return;
            }

            let tableHTML = '<table id="plan-sheet-table"><thead><tr>';
            
            const headers = Object.keys(plan[0]);
            const displayHeaders = headers.filter(h => h !== 'line_id');

            // Build Header Row
            displayHeaders.forEach(header => {
                // Shorten header text for display
                const shortHeader = header.toUpperCase().replace(/_/g, ' ').replace('IDENTIFICATION', 'ID').replace('NUMBER', 'NO');
                tableHTML += `<th>${shortHeader}</th>`;
            });
            tableHTML += '<th>ACTION</th>'; 
            tableHTML += '</tr></thead><tbody>';

            // Build Data Rows
            plan.forEach(row => {
                const isCompleted = row.status === 'completed';
                const rowClass = isCompleted ? 'plan-completed' : '';
                
                tableHTML += `<tr class="${rowClass}">`;
                
                displayHeaders.forEach(header => {
                    if (header === 'status') {
                        const statusText = isCompleted ? ' DONE' : ' PENDING';
                         tableHTML += `<td>${statusText}</td>`;
                    } else {
                        tableHTML += `<td>${row[header] || ''}</td>`;
                    }
                });
                
                // Action Button Column
                const buttonText = isCompleted ? 'Completed' : 'Mark Done';
                const buttonClass = isCompleted ? 'complete-button-completed' : 'complete-button-pending';
                const buttonAction = isCompleted ? '' : `onclick="markPlanLineComplete('${row.line_id}')"`;
                
                tableHTML += `<td><button class="complete-button ${buttonClass}" ${buttonAction} ${isCompleted ? 'disabled' : ''}>${buttonText}</button></td>`;
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            planDataView.innerHTML = tableHTML;
        }
        
        // --- LIVE MESSAGE TOAST FUNCTIONS ---
        let messageTimeout;
        
        function showMessageBox(message, type = 'info') {
            const colors = {
                'success': { bg: '#10B981', border: '#34D399', icon: '' },
                'error': { bg: '#EF4444', border: '#F87171', icon: '' },
                'warning': { bg: '#F59E0B', border: '#FCD34D', icon: '' },
                'info': { bg: '#3B82F6', border: '#60A5FA', icon: '' }
            };
            const style = colors[type] || colors['info'];

            messageContent.innerHTML = `${style.icon} ${message}`;
            messageBox.style.backgroundColor = style.bg;
            messageBox.style.borderLeftColor = style.border;
            messageBox.classList.add('active');
            
            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }
            
            messageTimeout = setTimeout(() => {
                hideMessageBox();
            }, 10000);
        }
        
        function hideMessageBox() {
            messageBox.classList.remove('active');
            if (messageTimeout) {
                clearTimeout(messageTimeout);
                messageTimeout = null;
            }
        }

        if (machineNameInput.value.trim()) {
            joinMachineRoom();
        }
    </script>
</body>
</html>