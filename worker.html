<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Production Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            padding: 20px; 
            background-color: #f4f7f9; 
            color: #333;
            /* min-height: 100vh; -- REMOVED to allow page to scroll */
        }
        .main-container {
            max-width: 1600px; 
            margin: auto; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        h1 { 
            color: #1F2937; 
            text-align: center; 
            border-bottom: 3px solid #3B82F6; 
            padding-bottom: 10px; 
            margin-bottom: 15px; 
            width: 100%; 
            font-size: 3rem; 
            font-weight: 900; 
        }
        
        .card { 
            background-color: #FFFAF0; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            width: 100%;
        }
        
        .card h2 {
            text-align: center;
        }
        
        label { display: block; margin-top: 5px; font-weight: 600; color: #4B5563; font-size: 0.85rem; }
        
        input:not(#produced-qty):not(#produced-length):not(#qty-produced-hours), select { 
            width: 100%; 
            padding: 7px; 
            margin-bottom: 5px; 
            box-sizing: border-box; 
            border-radius: 6px; 
            border: 1px solid #D1D5DB; 
            font-size: 14px; 
            transition: all 0.2s ease-in-out, box-shadow 0.2s ease-in-out; 
        }
        
        input:focus, select:focus { 
            border-color: #3B82F6; 
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); 
        }
        
        input[readonly] {
            background-color: #E5E7EB; 
            cursor: default;
            color: #4B5563; 
        }

        /* --- NEW VALIDATION STYLES (3-Color Concept) --- */
        .exact-match-input { /* Green: Exact match */
            border-color: #10B981 !important; 
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.25) !important;
        }
        .tolerable-match-input { /* Orange: Not exact, but accepted (within tolerance or > min pull force) */
            border-color: #F59E0B !important; 
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.25) !important;
        }
        .invalid-manual-input { /* Red: Data not match (Outside tolerance or < min pull force) */
            border-color: #EF4444 !important; /* Red */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.25) !important;
        }
        /* --- END NEW VALIDATION STYLES --- */

        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn-group button { 
            flex: 1; 
            padding: 10px; 
            font-weight: bold; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: background-color 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        #submit-button { background-color: #10B981; color: white; }
        #submit-button:hover { background-color: #059669; box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);}
        #reset-button { background-color: #EF4444; color: white; }
        #reset-button:hover { background-color: #DC2626; box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);}
        .message { text-align: center; font-weight: bold; margin-top: 15px; padding: 8px; border-radius: 4px; font-size: 0.9rem; }
        
        .input-row { display: flex; gap: 10px; margin-bottom: 5px; }
        .input-row > div { flex: 1; } 
        
        .input-row-qty { 
            margin-top: 15px; 
            margin-bottom: 10px; 
        }

        .input-row-qty > div > input {
            min-width: 100px; 
            font-size: 1.0rem; 
            padding: 10px 8px; 
            text-align: center; 
            font-weight: 700; 
            /* STYLES MODIFIED FOR LIGHT DARK GREEN */
            background-color: #E6F7E6; 
            border-color: #047857; 
            color: #047857;
            transition: all 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-row-qty label {
            text-align: center;
            font-size: 0.85rem;
            color: #065F46; 
            font-weight: 700;
        }
        
        #plan-sheet-container { 
            border: 2px solid #3B82F6; 
            border-radius: 8px; 
            padding: 15px;
            background-color: #EFF6FF;
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            /* flex-grow: 1; max-height: 100%; - REMOVED to allow content to dictate height */
        }
        #plan-data-view {
            /* flex-grow: 1; overflow-y: auto; - REMOVED to allow content to grow without internal scrollbar */
            margin-top: 10px;
        }

        #plan-sheet-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        #plan-sheet-table th, #plan-sheet-table td {
            padding: 8px 6px;
            text-align: left;
            border-bottom: 1px solid #E5E7EB;
            white-space: nowrap; 
        }
        #plan-sheet-table th {
            background-color: #DBEAFE; 
            color: #1E40AF; 
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #plan-sheet-table tr.plan-completed {
            background-color: #ECFDF5; 
            color: #065F46; 
            opacity: 0.7;
        }
        .plan-completed td {
            text-decoration: line-through;
        }

        .complete-button {
            padding: 6px 12px;
            font-weight: 600;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 0.8rem;
            cursor: pointer;
            min-width: 100px; 
        }

        .complete-button-pending {
            background-color: #3B82F6; 
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }
        .complete-button-pending:hover {
            background-color: #2563EB; 
        }
        .complete-button-completed {
            background-color: #10B981; 
            color: white;
            opacity: 0.5;
            cursor: default;
        }
        .plan-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1D4ED8; 
            padding-bottom: 8px;
            border-bottom: 2px solid #BFDBFE; 
        }
        
        .terminal-box {
            border: 1px solid #D1D5DB; 
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            background-color: #F5FFFA;
        }

        .title-and-id-row {
            display: flex;
            align-items: flex-end; 
            gap: 10px;
            width: fit-content; 
            margin: 5px auto 10px auto; 
            border-bottom: 1px solid #E5E7EB; 
            padding-bottom: 5px;
        }
        .title-and-id-row h3 {
            font-size: 1.0rem; 
            font-weight: 700;
            color: #1F2937;
            margin: 0; 
            padding: 0;
            flex-shrink: 0; 
            line-height: 1.25rem; 
        }
        .title-and-id-row .terminal-id-input-group {
            flex-grow: 0; 
            width: 180px; 
        }
        .title-and-id-row .terminal-id-input-group label {
            display: none; 
        }
        .title-and-id-row .terminal-id-input-group input {
            margin-bottom: 0;
            padding: 5px 7px; 
        }


        .input-row-8col { 
            display: grid; 
            grid-template-columns: repeat(8, 1fr); 
            gap: 10px; 
            margin-bottom: 5px;
        }
        .input-row-pull-force { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px; 
            margin-bottom: 10px;
        }
        .input-row-8col > div, .input-row-pull-force > div { 
            margin-bottom: 0;
        }

        #connection-card {
            padding: 10px 15px; 
        }
        
        #connection-card .input-row.items-end {
            max-width: 400px; 
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 5px;
        }
        
        #room-status {
            text-align: center;
        }
        
        .main-content-grid {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 20px; 
            width: 100%;
            align-items: flex-start;
        }
        @media (min-width: 1200px) { 
            .main-content-grid {
                grid-template-columns: 1.5fr 1.5fr; 
                /* max-height: calc(100vh - 40px); - REMOVED to allow page to scroll */
            }
        }
        .data-entry-container {
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }
        
        #join-room-button {
             padding-top: 8px;
             padding-bottom: 8px;
        }
        .submission-card {
            padding-top: 15px;
        }
        
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3B82F6; 
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            width: 300px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border-left: 5px solid #60A5FA; 
        }
        
        #toast-container.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>Production Data</h1>
        
        <div class="main-content-grid">
            
            <div class="data-entry-container">
                
                <div id="connection-card" class="card bg-indigo-50 border border-indigo-200">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">Connection Status</h2>
                    <div class="input-row items-end">
                        <div style="flex-grow: 2;">
                            <label for="machine-name-input">My Machine Name:</label>
                            <select id="machine-name-input" required class="uppercase">
                                <option value="" disabled selected>Select Machine</option>
                                <option value="AUM-002">AUM-002</option>
                                <option value="AUM-003">AUM-003</option>
                                <option value="AUM-009">AUM-009</option>
                                <option value="AUM-001">AUM-001</option>
                                <option value="AUM-010">AUM-010</option>
                                <option value="AUM-005">AUM-005</option>
                                <option value="AUM-011">AUM-011</option>
                                <option value="AUM-012">AUM-012</option>
                            </select>
                        </div>
                        <div style="flex-grow: 1;"> 
                            <button onclick="joinMachineRoom()" id="join-room-button" class="w-full bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                                Connect
                            </button>
                        </div>
                    </div>
                    <p id="room-status" class="text-xs mt-1 font-medium text-indigo-700">Not connected to a machine room.</p>
                    
                    <div class="p-4 mt-3 rounded-lg bg-yellow-50 border border-yellow-300" id="reference-data-card">
                        <p class="text-sm font-semibold text-gray-700 mb-2 text-center">Load Reference Data</p>
                        <div class="input-row justify-center">
                            <button id="excel-upload-button" onclick="openExcelFileSelector()" class="bg-amber-500 text-white font-semibold rounded-lg hover:bg-amber-600 transition duration-150 shadow-md p-2 flex items-center justify-center gap-2 w-full max-w-sm mx-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                                Load Reference Data
                            </button>
                            <input type="file" id="excel-file-input" accept=".xlsx, .xls" style="display: none;" onchange="handleExcelUpload(event)">
                        </div>
                    </div>
                    </div>

                <div class="card submission-card">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">Submit Production Output</h2>
                    <div class="input-row">
                        <div>
                            <label for="entry-date">Date:</label>
                            <input type="date" id="entry-date" required>
                        </div>
                        <div>
                            <label for="entry-time">Time:</label>
                            <input type="time" id="entry-time" required>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <div>
                            <label for="shift">Shift:</label>
                            <select id="shift" required>
                                <option value="" disabled selected>Select Shift</option>
                                <option value="A">Shift A</option>
                                <option value="B">Shift B</option>
                                <option value="C">Shift C</option>
                            </select>
                        </div>
                        <div>
                            <label for="operator-name">Operator Name:</label>
                            <input type="text" id="operator-name" required> 
                        </div>
                    </div>

                    <div class="input-row">
                        <div>
                            <label for="fg-part-no">FG Part No:</label>
                            <input type="text" id="fg-part-no" list="fg-part-no-list" placeholder="e.g., P-789" required oninput="autofillMeasuredData()">
                        </div>
                        <div>
                            <label for="cable-id">Cable ID:</label>
                            <input type="text" id="cable-id" list="cable-id-list" placeholder="e.g., 12" required oninput="autofillMeasuredData()">
                        </div>
                    </div>

                    <input type="hidden" id="machine-name" value="" required> 
                    
                    <div class="terminal-box">
                        <div class="title-and-id-row">
                            <h3>Terminal 1</h3>
                            <div class="terminal-id-input-group">
                                <label for="t1-terminal-id">Terminal Part Number:</label>
                                <input type="text" id="t1-terminal-id" placeholder="Enter Terminal Part Number">
                            </div>
                            <div class="terminal-id-input-group">
                                <label for="t1-apl-no">APL NO:</label>
                                <input type="text" id="t1-apl-no" placeholder="Enter APL NO:">
                            </div>
                        </div>
                            
                        <div class="input-row-8col">
                            <div>
                                <label for="t1-crimp-height-measured">Crimp H (mm) Meas:</label>
                                <input type="number" step="0.01" id="t1-crimp-height-measured" placeholder="" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t1-crimp-height-manual">Crimp H (mm) Man:</label>
                                <input type="number" step="0.01" id="t1-crimp-height-manual" oninput="validateManualInput(event)">
                            </div>
                            
                            <div>
                                <label for="t1-insulation-height-measured">Insulation H (mm) Meas:</label>
                                <input type="number" step="0.01" id="t1-insulation-height-measured" placeholder="" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t1-insulation-height-manual">Insulation H (mm) Man:</label>
                                <input type="number" step="0.01" id="t1-insulation-height-manual" oninput="validateManualInput(event)">
                            </div>
                            
                            <div>
                                <label for="t1-crimp-width-measured">Crimp W (mm) Meas:</label>
                                <input type="number" step="0.01" id="t1-crimp-width-measured" placeholder="" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t1-crimp-width-manual">Crimp W (mm) Man:</label>
                                <input type="number" step="0.01" id="t1-crimp-width-manual" oninput="validateManualInput(event)">
                            </div>
                            
                            <div>
                                <label for="t1-insulation-width-measured">Insulation W (mm) Meas:</label>
                                <input type="number" step="0.01" id="t1-insulation-width-measured" placeholder="" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t1-insulation-width-manual">Insulation W (mm) Man:</label>
                                <input type="number" step="0.01" id="t1-insulation-width-manual" oninput="validateManualInput(event)">
                            </div>
                        </div>
                            
                        <div class="input-row-pull-force">
                            <div>
                                <label for="t1-pull-force-measured">Pull Force (N) Meas:</label>
                                <input type="number" step="0.1" id="t1-pull-force-measured" placeholder="" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t1-pull-force-manual">Pull Force (N) Man:</label>
                                <input type="number" step="0.1" id="t1-pull-force-manual" oninput="validateManualInput(event)">
                            </div>
                            <div></div> 
                            <div></div> 
                        </div>
                    </div>
                    <div class="terminal-box">
                        <div class="title-and-id-row">
                            <h3>Terminal 2</h3>
                            <div class="terminal-id-input-group">
                                <label for="t2-terminal-id">Terminal Part Number:</label>
                                <input type="text" id="t2-terminal-id" placeholder="Enter Terminal Part Number">
                            </div>
                            <div class="terminal-id-input-group">
                                <label for="t2-apl-no">APL NO:</label>
                                <input type="text" id="t2-apl-no" placeholder="Enter APL NO:">
                            </div>
                        </div>
                            
                        <div class="input-row-8col">
                            <div>
                                <label for="t2-crimp-height-measured">Crimp H (mm) Meas:</label>
                                <input type="number" step="0.01" id="t2-crimp-height-measured" placeholder="" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t2-crimp-height-manual">Crimp H (mm) Man:</label>
                                <input type="number" step="0.01" id="t2-crimp-height-manual" oninput="validateManualInput(event)">
                            </div>
                            
                            <div>
                                <label for="t2-insulation-height-measured">Insulation H (mm) Meas:</label>
                                <input type="number" step="0.01" id="t2-insulation-height-measured" placeholder="" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t2-insulation-height-manual">Insulation H (mm) Man:</label>
                                <input type="number" step="0.01" id="t2-insulation-height-manual" oninput="validateManualInput(event)">
                            </div>
                            
                            <div>
                                <label for="t2-crimp-width-measured">Crimp W (mm) Meas:</label>
                                <input type="number" step="0.01" id="t2-crimp-width-measured" placeholder="" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t2-crimp-width-manual">Crimp W (mm) Man:</label>
                                <input type="number" step="0.01" id="t2-crimp-width-manual" oninput="validateManualInput(event)">
                            </div>
                            
                            <div>
                                <label for="t2-insulation-width-measured">Insulation W (mm) Meas:</label>
                                <input type="number" step="0.01" id="t2-insulation-width-measured" placeholder="" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t2-insulation-width-manual">Insulation W (mm) Man:</label>
                                <input type="number" step="0.01" id="t2-insulation-width-manual" oninput="validateManualInput(event)">
                            </div>
                        </div>
                            
                        <div class="input-row-pull-force">
                            <div>
                                <label for="t2-pull-force-measured">Pull Force (N) Meas:</label>
                                <input type="number" step="0.1" id="t2-pull-force-measured" placeholder="" readonly tabindex="-1">
                            </div>
                            <div>
                                <label for="t2-pull-force-manual">Pull Force (N) Man:</label>
                                <input type="number" step="0.1" id="t2-pull-force-manual" oninput="validateManualInput(event)">
                            </div>
                            <div></div> 
                            <div></div> 
                        </div>
                    </div>
                    <div class="input-row input-row-qty">
                        <div>
                            <label for="produced-qty">Produced Qty:</label>
                            <input type="number" id="produced-qty" required min="1">
                        </div>
                        <div>
                            <label for="produced-length">Length (M/F):</label>
                            <input type="number" step="any" id="produced-length" required min="0.1" oninput="autofillMeasuredData()">
                        </div>
                        <div>
                            <label for="qty-produced-hours">Hours:</label>
                            <input type="number" step="0.1" id="qty-produced-hours" required min="0.1">
                        </div>
                    </div>

                    <div class="btn-group">
                        <button id="submit-button" onclick="submitOutput()">Submit Data</button>
                        <button id="reset-button" onclick="resetForm()">Reset Fields</button>
                    </div>

                    <div id="message" class="message"></div>
                    
                    <datalist id="fg-part-no-list"></datalist>
                    <datalist id="cable-id-list"></datalist>
                </div>
            </div> 
            
            <div id="plan-sheet-container" class="card">
                <div class="plan-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    <span class="text-lg">Active Plan Sheet:</span>
                    <span id="current-plan-machine" class="text-base font-normal">N/A</span>
                </div>
                <div id="plan-data-view">
                    <p class="text-gray-500 italic text-sm">Plan data will appear here after the dashboard assigns a sheet.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-box">
        <div class="flex justify-between items-center mb-1">
            <h2 class="text-sm font-semibold text-white flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                Live Message
            </h2>
            <button onclick="hideMessageBox()" class="text-white hover:text-gray-200 focus:outline-none -mt-1 -mr-1 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <p id="live-message-content" class="text-sm text-white font-medium"></p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        const machineNameInput = document.getElementById('machine-name-input');
        const machineNameHidden = document.getElementById('machine-name');
        const roomStatus = document.getElementById('room-status');
        const planDataView = document.getElementById('plan-data-view');
        const currentPlanMachine = document.getElementById('current-plan-machine');
        const connectionCard = document.getElementById('connection-card');
        const messageBox = document.getElementById('toast-container');
        const messageContent = document.getElementById('live-message-content');
        
        // GLOBAL LOOKUP TABLE for Excel Data
        let measuredDataLookup = [];

        // --- NEW: EXCEL KEY MAPPING AND NORMALIZATION LOGIC (FIXED) ---
        const EXCEL_HEADER_MAP = {
            "fgpartno": "FG_PART_NO",
            "cableid": "CABLE_ID",
            "length": "LENGTH_SPEC", 
            "lengthspec": "LENGTH_SPEC", 
            
            "t1terminalid": "T1_TERMINAL_ID",
            "t1terminalpartnumber": "T1_TERMINAL_ID",
            "t1aplno": "T1_APL_NO",
            "t2terminalid": "T2_TERMINAL_ID",
            "t2terminalpartnumber": "T2_TERMINAL_ID",
            "t2aplno": "T2_APL_NO",

            "t1crimph": "T1_CRIMP_H",
            "t1crimphmm": "T1_CRIMP_H", 
            "t1insulationh": "T1_INSULATION_H",
            "t1insulationhmm": "T1_INSULATION_H", 
            "t1crimpw": "T1_CRIMP_W",
            "t1crimpwmm": "T1_CRIMP_W",
            "t1insulationw": "T1_INSULATION_W",
            "t1insulationwmm": "T1_INSULATION_W",
            "t1pullforce": "T1_PULL_FORCE",
            "t1pullforcen": "T1_PULL_FORCE", 

            "t2crimph": "T2_CRIMP_H",
            "t2crimphmm": "T2_CRIMP_H", 
            "t2insulationh": "T2_INSULATION_H",
            "t2insulationhmm": "T2_INSULATION_H",
            "t2crimpw": "T2_CRIMP_W",
            "t2crimpwmm": "T2_CRIMP_W",
            "t2insulationw": "T2_INSULATION_W",
            "t2insulationwmm": "T2_INSULATION_W",
            "t2pullforce": "T2_PULL_FORCE",
            "t2pullforcen": "T2_PULL_FORCE",
        };

        /** Normalizes an Excel header string by removing non-alphanumeric chars (excluding spaces, but spaces are removed later) and converting to lowercase. */
        function normalizeHeader(header) {
            // Removes spaces, parentheses, and all non-alphanumeric characters, then lowercases.
            return String(header).replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
        }

        /** Remaps keys in an Excel row object from potentially inconsistent header names to standard internal names. */
        function normalizeExcelRow(rawRow) {
            const standardizedRow = {};
            for (const key in rawRow) {
                if (Object.hasOwnProperty.call(rawRow, key)) {
                    const normalizedKey = normalizeHeader(key);
                    const standardKey = EXCEL_HEADER_MAP[normalizedKey];
                    
                    // Map to the standard key if found
                    if (standardKey) {
                        standardizedRow[standardKey] = rawRow[key];
                    }
                }
            }
            return standardizedRow;
        }
        // --- END NEW LOGIC ---

        function setInitialDateTime() {
            const now = new Date();
            const year = String(now.getFullYear());
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            document.getElementById('entry-date').value = `${year}-${month}-${day}`;
            document.getElementById('entry-time').value = `${hours}:${minutes}`;
        }
        
        document.addEventListener('DOMContentLoaded', setInitialDateTime);

        function joinMachineRoom() {
            const machineName = machineNameInput.value.toUpperCase();
            if (!machineName) {
                alert("Please select a Machine Name.");
                return;
            }
            machineNameHidden.value = machineName;
            
            machineNameInput.disabled = true;
            document.getElementById('join-room-button').disabled = true;
            roomStatus.textContent = `Connecting to room: ${machineName}...`;
            
            socket.emit('join_machine_room', { machineName: machineName });
        }
        
        // **MODIFIED: This function now performs a partial clear (used after submission)**
        function clearProductionFields() {
            // Shift and Operator Name are intentionally NOT cleared here (as requested by user)
            document.getElementById('fg-part-no').value = ''; 
            document.getElementById('cable-id').value = ''; 
            document.getElementById('produced-qty').value = '';
            document.getElementById('produced-length').value = '';
            document.getElementById('qty-produced-hours').value = '';
            
            // Terminal Manual/Measured fields to clear
            const terminalFields = [
                // T1
                't1-terminal-id', 't1-apl-no',
                't1-crimp-height-measured', 't1-crimp-height-manual',
                't1-insulation-height-measured', 't1-insulation-height-manual',
                't1-crimp-width-measured', 't1-crimp-width-manual',
                't1-insulation-width-measured', 't1-insulation-width-manual',
                't1-pull-force-measured', 't1-pull-force-manual',
                // T2
                't2-terminal-id', 't2-apl-no',
                't2-crimp-height-measured', 't2-crimp-height-manual',
                't2-insulation-height-measured', 't2-insulation-height-manual',
                't2-crimp-width-measured', 't2-crimp-width-manual',
                't2-insulation-width-measured', 't2-insulation-width-manual',
                't2-pull-force-measured', 't2-pull-force-manual'
            ];

            terminalFields.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.value = '';
                    // UPDATED: Clear new 3-color validation styles
                    input.classList.remove('exact-match-input', 'tolerable-match-input', 'invalid-manual-input');
                    input.removeAttribute('data-tolerance');
                    input.removeAttribute('data-invalid'); // Clear new invalid attribute
                }
            });

            document.getElementById('message').textContent = '';
            setInitialDateTime(); // Reset date/time to current
        }

        // **MODIFIED: The Reset Button function (calls partial clear + clears persistent fields)**
        function resetForm() {
            clearProductionFields(); // Clear all production-specific fields
            // Reset the persistent fields for a full reset
            document.getElementById('shift').value = '';
            document.getElementById('operator-name').value = '';
        }

        function markPlanLineComplete(lineId) {
            socket.emit('mark_plan_complete', { lineId: lineId, machineName: machineNameHidden.value });
        }
        
        // --- UPDATED Autofill Function ---
        function clearMeasuredFields() {
            const measuredFields = [
                // T1
                't1-terminal-id', 't1-apl-no',
                't1-crimp-height-measured', 't1-insulation-height-measured', 't1-crimp-width-measured', 
                't1-insulation-width-measured', 't1-pull-force-measured', 
                // T2
                't2-terminal-id', 't2-apl-no',
                't2-crimp-height-measured', 't2-insulation-height-measured', 't2-crimp-width-measured', 
                't2-insulation-width-measured', 't2-pull-force-measured'
            ];
            
            const manualFields = [
                't1-crimp-height-manual', 't1-insulation-height-manual', 't1-crimp-width-manual', 
                't1-insulation-width-manual', 't1-pull-force-manual', 
                't2-crimp-height-manual', 't2-insulation-height-manual', 't2-crimp-width-manual', 
                't2-insulation-width-manual', 't2-pull-force-manual'
            ];

            measuredFields.forEach(id => {
                const input = document.getElementById(id);
                input.value = '';
                input.removeAttribute('data-tolerance');
            });
            manualFields.forEach(id => {
                 const input = document.getElementById(id);
                 // UPDATED: Clear new 3-color validation styles
                 input.classList.remove('exact-match-input', 'tolerable-match-input', 'invalid-manual-input');
                 input.removeAttribute('data-invalid'); // Clear new invalid attribute
            });
        }
        
        function autofillMeasuredData() {
            const fgPartNoInput = document.getElementById('fg-part-no').value.trim();
            const cableIdInput = document.getElementById('cable-id').value.trim();
            const producedLengthInput = parseFloat(document.getElementById('produced-length').value.trim()); 
            
            clearMeasuredFields(); 
            
            if (!fgPartNoInput || !cableIdInput || isNaN(producedLengthInput) || producedLengthInput <= 0 || measuredDataLookup.length === 0) {
                return;
            }
            
            const match = measuredDataLookup.find(row => 
                row.FG_PART_NO === fgPartNoInput && 
                row.CABLE_ID === cableIdInput &&
                row.BASE_LENGTH !== undefined && 
                producedLengthInput >= (row.BASE_LENGTH - row.TOLERANCE) &&
                producedLengthInput <= (row.BASE_LENGTH + row.TOLERANCE)
            );

            // Helper to set measured value and tolerance attribute
            const setMeasuredData = (idPrefix, specKey) => {
                const baseKey = `${specKey}_BASE`;
                const toleranceKey = `${specKey}_TOLERANCE`;
                
                const measuredInputId = `${idPrefix}-measured`;
                const measuredInput = document.getElementById(measuredInputId);
                
                const baseValue = match[baseKey];
                const toleranceValue = match[toleranceKey];
                
                if (baseValue !== '' && baseValue !== undefined && !isNaN(baseValue)) {
                    measuredInput.value = baseValue;
                    measuredInput.setAttribute('data-tolerance', toleranceValue);
                } else {
                    measuredInput.value = '';
                    measuredInput.removeAttribute('data-tolerance');
                }
                
                // Manually trigger the validation check if a manual value exists
                const manualInputId = `${idPrefix}-manual`;
                const manualInput = document.getElementById(manualInputId);
                if (manualInput && manualInput.value.trim() !== '') {
                    validateManualInput({ target: manualInput });
                } else if (manualInput) {
                    // Clear styles if no manual value is present
                    manualInput.classList.remove('exact-match-input', 'tolerable-match-input', 'invalid-manual-input');
                    manualInput.removeAttribute('data-invalid'); // Clear new invalid attribute
                }
            };
            
            if (match) {
                // Terminal 1 Data - Non-Spec Fields
                document.getElementById('t1-terminal-id').value = match.T1_TERMINAL_ID || ''; 
                document.getElementById('t1-apl-no').value = match.T1_APL_NO || ''; 
                // Terminal 1 Data - Spec Fields
                setMeasuredData('t1-crimp-height', 'T1_CRIMP_H');
                setMeasuredData('t1-insulation-height', 'T1_INSULATION_H');
                setMeasuredData('t1-crimp-width', 'T1_CRIMP_W');
                setMeasuredData('t1-insulation-width', 'T1_INSULATION_W');
                setMeasuredData('t1-pull-force', 'T1_PULL_FORCE');
                
                // Terminal 2 Data - Non-Spec Fields
                document.getElementById('t2-terminal-id').value = match.T2_TERMINAL_ID || ''; 
                document.getElementById('t2-apl-no').value = match.T2_APL_NO || ''; 
                // Terminal 2 Data - Spec Fields
                setMeasuredData('t2-crimp-height', 'T2_CRIMP_H');
                setMeasuredData('t2-insulation-height', 'T2_INSULATION_H');
                setMeasuredData('t2-crimp-width', 'T2_CRIMP_W');
                setMeasuredData('t2-insulation-width', 'T2_INSULATION_W');
                setMeasuredData('t2-pull-force', 'T2_PULL_FORCE');

                showMessageBox(`Full reference data for ${fgPartNoInput} / ${cableIdInput} / ${producedLengthInput} (within tolerance) autofilled from check sheet.`, 'success');
            } else {
                
                let debugMessage = `No matching reference data found for ${fgPartNoInput} / ${cableIdInput} / ${producedLengthInput}. `;
                
                const fgMatches = measuredDataLookup.filter(row => row.FG_PART_NO === fgPartNoInput);
                
                if (fgMatches.length > 0) {
                    debugMessage += `Found ${fgMatches.length} rows with matching FG Part No. `;
                    
                    const cableMatches = fgMatches.filter(row => row.CABLE_ID === cableIdInput);
                    
                    if (cableMatches.length > 0) {
                        debugMessage += `Found ${cableMatches.length} rows also matching Cable ID. Length must be out of tolerance.`;
                        if (cableMatches[0].BASE_LENGTH !== undefined) {
                            debugMessage += ` (Check that ${producedLengthInput} is between ${cableMatches[0].BASE_LENGTH - cableMatches[0].TOLERANCE} and ${cableMatches[0].BASE_LENGTH + cableMatches[0].TOLERANCE})`;
                        }
                    } else {
                         debugMessage += `Cable ID "${cableIdInput}" was not found in combination with the FG Part No.`;
                    }
                    
                } else {
                    debugMessage += `FG Part No "${fgPartNoInput}" was not found in the loaded sheet.`;
                }

                showMessageBox(debugMessage, 'warning');
            }
        }
        
        // --- NEW/UPDATED: Function to extract base numeric value and tolerance from specification string ---
        /** * Attempts to extract a base numeric value and tolerance from a string that might contain specifications, 
         * tolerances, and units (e.g., "2.10±0.1 (SC)", "120 N").
         * Applies default tolerance if none is explicitly found.
         */
        function parseSpecification(value, fieldType) {
            const DEFAULT_TOLERANCE_DIMENSIONAL = 0.1;
            const DEFAULT_TOLERANCE_PULL_FORCE = 10.0;
            
            let base = '';
            let tolerance = '';
            
            // If the value is already a number (raw data from Excel), use it as base and apply default tolerance
            if (typeof value === 'number') {
                base = value; 
                tolerance = (fieldType === 'PULL_FORCE') ? DEFAULT_TOLERANCE_PULL_FORCE : DEFAULT_TOLERANCE_DIMENSIONAL;
                return { base, tolerance };
            }
            if (typeof value !== 'string') {
                return { base: '', tolerance: '' };
            }
            
            let str = value.trim().toUpperCase();

            // 1. Handle Pull Force (N) - Remove 'N' if present
            if (str.endsWith('N')) {
                str = str.replace('N', '').trim();
            }
            
            // 2. Look for explicit base ± tolerance pattern: e.g., "2.10±0.1", "0.95 +/ 0.05", "1.25(±0.1)"
            const explicitMatch = str.match(/^(\d+(?:\.\d+)?)(?:[\s(]*[+-±]\s*(\d+(?:\.\d+)?))?/);
            if (explicitMatch) {
                base = parseFloat(explicitMatch[1]);
                
                // If tolerance is found in the match group 2
                if (explicitMatch[2]) {
                    tolerance = parseFloat(explicitMatch[2]);
                }
            } 
            
            // 3. Apply default tolerance if base is found but tolerance isn't explicit
            if (base !== '' && !isNaN(base)) {
                if (tolerance === '') {
                    tolerance = (fieldType === 'PULL_FORCE') 
                        ? DEFAULT_TOLERANCE_PULL_FORCE 
                        : DEFAULT_TOLERANCE_DIMENSIONAL;
                }
            } else {
                // If no number could be parsed at all
                base = '';
                tolerance = '';
            }
            
            return { base, tolerance };
        }
        // --- END NEW FUNCTION ---

        /** UPDATED FUNCTION: Performs live validation on a manual input field against its corresponding measured value and tolerance, applying the 3-color scheme. */
        function validateManualInput(event) {
            const manualInput = event.target;
            const manualId = manualInput.id;
            
            // Derive the ID for the corresponding measured field. 
            const measuredId = manualId.replace('-manual', '-measured');
            const measuredInput = document.getElementById(measuredId);
            
            // Clear previous validation styles and invalid data attribute
            manualInput.classList.remove('exact-match-input', 'tolerable-match-input', 'invalid-manual-input');
            manualInput.removeAttribute('data-invalid');
            
            if (!measuredInput) {
                return; // No corresponding measured field
            }

            const manualValue = parseFloat(manualInput.value);
            const measuredValue = parseFloat(measuredInput.value);
            
            // Only validate if required numeric data is present and the user has entered a value
            if (manualInput.value.trim() === '' || isNaN(manualValue) || isNaN(measuredValue)) {
                return; 
            }

            let validationType = 'invalid'; // Default to red/invalid
            const epsilon = 0.0001; // Use a small epsilon for floating point comparison

            if (manualId.includes('pull-force')) {
                // Pull Force Logic (Minimum strength required)
                if (manualValue < measuredValue) {
                    validationType = 'invalid'; // Red: Less than minimum required
                } else if (Math.abs(manualValue - measuredValue) < epsilon) {
                    validationType = 'exact'; // Green: Exactly the minimum required
                } else { // manualValue > measuredValue
                    validationType = 'tolerable'; // Orange: Greater than minimum required (accepted but not exact)
                }
            } else {
                // Dimensional Measurements Logic (Tolerance +/-)
                // This covers: Crimp H/W, Insulation H/W for both T1 & T2
                const tolerance = parseFloat(measuredInput.getAttribute('data-tolerance'));
                
                if (isNaN(tolerance)) {
                    return;
                }
                
                const difference = Math.abs(manualValue - measuredValue);
                
                if (difference > tolerance) {
                    validationType = 'invalid'; // Red: Outside tolerance
                } else if (Math.abs(difference) < epsilon) { // If manualValue is effectively equal to measuredValue
                    validationType = 'exact'; // Green: Exact match
                } else { 
                    validationType = 'tolerable'; // Orange: Within tolerance but not exact
                }
            }
            
            // Apply the final style based on validationType
            if (validationType === 'exact') {
                manualInput.classList.add('exact-match-input');
            } else if (validationType === 'tolerable') {
                manualInput.classList.add('tolerable-match-input');
            } else { // 'invalid'
                manualInput.classList.add('invalid-manual-input');
                manualInput.setAttribute('data-invalid', 'true'); // Block submission
            }
        }
        
        /** NEW FUNCTION: Populates the datalists for FG Part No and Cable ID from the loaded lookup data. */
        function populateDatalists(lookupData) {
            const fgList = document.getElementById('fg-part-no-list');
            const cableList = document.getElementById('cable-id-list');
            
            // Clear existing options
            fgList.innerHTML = '';
            cableList.innerHTML = '';

            if (lookupData.length === 0) {
                return;
            }

            // Get unique FG Part Nos
            const uniqueFgPartNos = [...new Set(lookupData
                .map(row => row.FG_PART_NO)
                .filter(value => value))]; // Filter out empty/null/undefined
            
            uniqueFgPartNos.forEach(fg => {
                const option = document.createElement('option');
                option.value = fg;
                fgList.appendChild(option);
            });

            // Get unique Cable IDs
            const uniqueCableIds = [...new Set(lookupData
                .map(row => row.CABLE_ID)
                .filter(value => value))]; // Filter out empty/null/undefined
            
            uniqueCableIds.forEach(cable => {
                const option = document.createElement('option');
                option.value = cable;
                cableList.appendChild(option);
            });
        }
        
        // --- FIXED: Excel Upload Functions (Using the new parser) ---
        function openExcelFileSelector() {
            document.getElementById('excel-file-input').click();
        }

        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const refDataCard = document.getElementById('reference-data-card');
            refDataCard.className = refDataCard.className.replace(/bg-\w+-\d+ border-?\w*-\d+/g, '').trim(); 
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellStyles: true, raw: true }); 
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    const rawJsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (rawJsonData.length === 0) {
                        throw new Error('No data rows found. Ensure data starts on row 2 with headers on row 1.');
                    }
                    
                    // --- MODIFIED: Key Normalization and Parsing (Including Base/Tolerance) ---
                    measuredDataLookup = rawJsonData.map(rawRow => {
                        const standardizedRow = normalizeExcelRow(rawRow); 
                        const newRow = {};
                        
                        // 1. Copy non-spec fields
                        newRow.FG_PART_NO = String(standardizedRow.FG_PART_NO || '').trim();
                        newRow.CABLE_ID = String(standardizedRow.CABLE_ID || '').trim();
                        newRow.T1_TERMINAL_ID = standardizedRow.T1_TERMINAL_ID || '';
                        newRow.T1_APL_NO = standardizedRow.T1_APL_NO || '';
                        newRow.T2_TERMINAL_ID = standardizedRow.T2_TERMINAL_ID || '';
                        newRow.T2_APL_NO = standardizedRow.T2_APL_NO || '';
                        
                        // Helper to parse and assign base/tolerance for a spec field
                        const parseAndAssign = (standardKey, type) => {
                            const spec = standardizedRow[standardKey];
                            const { base, tolerance } = parseSpecification(spec, type);
                            newRow[`${standardKey}_BASE`] = base;
                            newRow[`${standardKey}_TOLERANCE`] = tolerance;
                        };
                        
                        // 2. Parse and Extract base numeric values for Crimp/Pull Force fields (Dimensional)
                        parseAndAssign('T1_CRIMP_H', 'DIMENSIONAL');
                        parseAndAssign('T1_INSULATION_H', 'DIMENSIONAL');
                        parseAndAssign('T1_CRIMP_W', 'DIMENSIONAL');
                        parseAndAssign('T1_INSULATION_W', 'DIMENSIONAL');
                        parseAndAssign('T1_PULL_FORCE', 'PULL_FORCE');
                        
                        parseAndAssign('T2_CRIMP_H', 'DIMENSIONAL');
                        parseAndAssign('T2_INSULATION_H', 'DIMENSIONAL');
                        parseAndAssign('T2_CRIMP_W', 'DIMENSIONAL');
                        parseAndAssign('T2_CRIMP_W', 'DIMENSIONAL'); // DUPED, but let's keep it consistent
                        parseAndAssign('T2_INSULATION_W', 'DIMENSIONAL');
                        parseAndAssign('T2_PULL_FORCE', 'PULL_FORCE');
                        
                        // 3. Parse LENGTH SPEC
                        const lengthRaw = String(standardizedRow.LENGTH_SPEC || '').trim();
                        const lengthMatch = lengthRaw.match(/(\d+(?:\.\d+)?)\s*[+-±]\s*(\d+(?:\.\d+)?)/); 

                        if (lengthMatch) {
                            newRow.BASE_LENGTH = parseFloat(lengthMatch[1]); 
                            newRow.TOLERANCE = parseFloat(lengthMatch[2]);   
                        } else {
                            // If no tolerance is specified for length, assume fixed length with tolerance 0.
                            const fixedLength = parseFloat(lengthRaw);
                            if (!isNaN(fixedLength)) {
                                newRow.BASE_LENGTH = fixedLength;
                                newRow.TOLERANCE = 0; 
                            } else {
                                newRow.BASE_LENGTH = undefined;
                                newRow.TOLERANCE = undefined;
                            }
                        }
                        
                        return newRow;
                    }).filter(row => row.FG_PART_NO && row.CABLE_ID && row.BASE_LENGTH !== undefined); 
                    // --- END MODIFIED ---

                    refDataCard.className += ' bg-emerald-50 border border-emerald-400';
                    
                    // NEW: Populate the datalists with unique values
                    populateDatalists(measuredDataLookup);
                    
                    showMessageBox(`Successfully loaded and parsed ${measuredDataLookup.length} valid records from Check Sheet. Specification values were converted to base numbers.`, 'success');

                } catch (error) {
                    refDataCard.className += ' bg-red-50 border border-red-400';

                    showMessageBox(`Error processing file: ${error.message}`, 'error');
                    measuredDataLookup = []; 
                    populateDatalists([]); // Clear lists on error
                } finally {
                    event.target.value = '';
                }
            };

            reader.onerror = function() {
                refDataCard.className += ' bg-red-50 border border-red-400';

                showMessageBox('Error reading the file.', 'error');
                measuredDataLookup = [];
                populateDatalists([]); // Clear lists on error
            };

            reader.readAsArrayBuffer(file);
        }
        // --- END FIXED Excel Upload Functions ---


        /** UPDATED FUNCTION: Submit Output with Pre-Submission Validation Check and ONLY sending manual data. */
        function submitOutput() {
            const machineName = machineNameHidden.value;
            if (!machineName) {
                showMessageBox('Error: Please connect to a Machine Room first!', 'error');
                return;
            }
            
            if (!document.querySelector('#entry-date').checkValidity() || !document.querySelector('#entry-time').checkValidity() || !document.querySelector('#shift').checkValidity() || !document.querySelector('#operator-name').checkValidity() || !document.querySelector('#fg-part-no').checkValidity() || !document.querySelector('#cable-id').checkValidity()) {
                showMessageBox('Please fill in all general required fields.', 'error');
                return;
            }
            
            // --- NEW VALIDATION CHECK: Terminal Manual Input ---
            const manualInputs = [
                't1-crimp-height-manual', 't1-insulation-height-manual', 't1-crimp-width-manual', 
                't1-insulation-width-manual', 't1-pull-force-manual', 
                't2-crimp-height-manual', 't2-insulation-height-manual', 't2-crimp-width-manual', 
                't2-insulation-width-manual', 't2-pull-force-manual'
            ];
            
            let invalidInputFound = false;
            let invalidFieldName = '';

            for (const id of manualInputs) {
                const input = document.getElementById(id);
                // Check if the input has a value AND is marked as invalid (RED status) by the live validation function
                if (input && input.value.trim() !== '' && input.getAttribute('data-invalid') === 'true') {
                    invalidInputFound = true;
                    // Get the label text for the error message
                    const label = document.querySelector(`label[for="${id}"]`);
                    invalidFieldName = label ? label.textContent.replace(':', '').trim() : id;
                    break;
                }
            }
            
            if (invalidInputFound) {
                showMessageBox(`Submission Blocked: The manual input for "${invalidFieldName}" does not meet the measurement specification (Red status). Please correct the value or clear the field to skip the measurement.`, 'error');
                return; // STOP SUBMISSION
            }
            // --- END NEW VALIDATION CHECK ---

            const qty = parseInt(document.getElementById('produced-qty').value);
            const length = parseFloat(document.getElementById('produced-length').value);
            const hours = parseFloat(document.getElementById('qty-produced-hours').value);

            if (isNaN(qty) || qty < 1) {
                 showMessageBox('Quantity must be a positive whole number.', 'error');
                 return;
            }
            if (isNaN(length) || length <= 0) {
                 showMessageBox('Length must be a positive number.', 'error');
                 return;
            }
            if (isNaN(hours) || hours <= 0) {
                 showMessageBox('Hours must be a positive number.', 'error');
                 return;
            }
            
            document.getElementById('message').textContent = 'Submitting data...';
            document.getElementById('message').style.backgroundColor = '#EFF6FF';
            document.getElementById('message').style.color = '#1E40AF';

            // **MODIFIED: ONLY SEND MANUAL INPUTS, NOT MEASURED INPUTS**
            const data = {
                shift: document.getElementById('shift').value,
                operator_name: document.getElementById('operator-name').value, 
                machine_name: machineName,
                fg_part_no: document.getElementById('fg-part-no').value,
                cable_id: document.getElementById('cable-id').value,
                produced_qty: qty,
                produced_length: length,
                qty_produced_hours: hours,
                entry_date: document.getElementById('entry-date').value, 
                entry_time: document.getElementById('entry-time').value,
                
                // Terminal 1 (IDs + Manual Data)
                t1_terminal_id: document.getElementById('t1-terminal-id').value,
                t1_apl_no: document.getElementById('t1-apl-no').value,
                t1_crimp_height_manual: parseFloat(document.getElementById('t1-crimp-height-manual').value),
                t1_insulation_height_manual: parseFloat(document.getElementById('t1-insulation-height-manual').value),
                t1_crimp_width_manual: parseFloat(document.getElementById('t1-crimp-width-manual').value),
                t1_insulation_width_manual: parseFloat(document.getElementById('t1-insulation-width-manual').value),
                t1_pull_force_manual: parseFloat(document.getElementById('t1-pull-force-manual').value),
                
                // Terminal 2 (IDs + Manual Data)
                t2_terminal_id: document.getElementById('t2-terminal-id').value,
                t2_apl_no: document.getElementById('t2-apl-no').value,
                t2_crimp_height_manual: parseFloat(document.getElementById('t2-crimp-height-manual').value),
                t2_insulation_height_manual: parseFloat(document.getElementById('t2-insulation-height-manual').value),
                t2_crimp_width_manual: parseFloat(document.getElementById('t2-crimp-width-manual').value),
                t2_insulation_width_manual: parseFloat(document.getElementById('t2-insulation-width-manual').value),
                t2_pull_force_manual: parseFloat(document.getElementById('t2-pull-force-manual').value)
            };

            socket.emit('submit_output', data);

            // **MODIFIED: Clear only production fields, keeping Shift/Operator Name**
            clearProductionFields(); 

            document.getElementById('message').textContent = 'Output submitted successfully! Ready for next entry.';
            setTimeout(() => { document.getElementById('message').textContent = ''; }, 3000); 
        }

        socket.on('join_confirm', (data) => {
            if (data.success) {
                roomStatus.textContent = `Connected to room: ${data.machineName}. Plan loaded.`;
                roomStatus.className = 'text-xs mt-1 font-bold text-green-700';
                connectionCard.style.backgroundColor = '#F0FFF4';
                connectionCard.style.borderColor = '#34D399';
            } else {
                roomStatus.textContent = `Error connecting: ${data.reason}`;
                roomStatus.className = 'text-xs mt-1 font-bold text-red-700';
                machineNameInput.disabled = false;
                document.getElementById('join-room-button').disabled = false;
            }
        });
        
        socket.on('update_worker_plan', (data) => {
            if (data.machineName === machineNameHidden.value) {
                displayPlanSheet(data.plan, data.machineName);
            }
        });

        socket.on('submission_success', (data) => {
             document.getElementById('message').textContent = 'Output submitted successfully!';
             setTimeout(() => {
                 document.getElementById('message').textContent = '';
             }, 3000);
        });
        
        socket.on('live_message', (data) => {
            showMessageBox(data.message, 'info');
        });

        function displayPlanSheet(plan, machineName) {
            currentPlanMachine.textContent = machineName;
            
            if (plan.length === 0) {
                planDataView.innerHTML = '<p class="text-gray-500 italic text-sm">No plan sheet assigned for this machine.</p>';
                return;
            }

            let tableHTML = '<table id="plan-sheet-table"><thead><tr>';
            
            const headers = Object.keys(plan[0]);
            const displayHeaders = headers.filter(h => h !== 'line_id');

            displayHeaders.forEach(header => {
                const shortHeader = header.toUpperCase().replace(/_/g, ' ').replace('IDENTIFICATION', 'ID').replace('NUMBER', 'NO');
                tableHTML += `<th>${shortHeader}</th>`;
            });
            tableHTML += '<th>ACTION</th>'; 
            tableHTML += '</tr></thead><tbody>';

            plan.forEach(row => {
                const isCompleted = row.status === 'completed';
                const rowClass = isCompleted ? 'plan-completed' : '';
                
                tableHTML += `<tr class="${rowClass}">`;
                
                displayHeaders.forEach(header => {
                    if (header === 'status') {
                        const statusText = isCompleted ? '✅ DONE' : '🕒 PENDING';
                         tableHTML += `<td>${statusText}</td>`;
                    } else {
                        tableHTML += `<td>${row[header] || ''}</td>`;
                    }
                });
                
                const buttonText = isCompleted ? 'Completed' : 'Mark Done';
                const buttonClass = isCompleted ? 'complete-button-completed' : 'complete-button-pending';
                const buttonAction = isCompleted ? '' : `onclick="markPlanLineComplete('${row.line_id}')"`;
                
                tableHTML += `<td><button class="complete-button ${buttonClass}" ${buttonAction} ${isCompleted ? 'disabled' : ''}>${buttonText}</button></td>`;
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            planDataView.innerHTML = tableHTML;
        }
        
        let messageTimeout;
        
        function showMessageBox(message, type = 'info') {
            const colors = {
                'success': { bg: '#10B981', border: '#34D399', icon: '✅' },
                'error': { bg: '#EF4444', border: '#F87171', icon: '❌' },
                'warning': { bg: '#F59E0B', border: '#FCD34D', icon: '⚠️' },
                // FIX: Added missing quote and comma here
                'info': { bg: '#3B82F6', border: '#60A5FA', icon: '💬' } 
            };
            const style = colors[type] || colors['info'];

            messageContent.innerHTML = `${style.icon} ${message}`;
            messageBox.style.backgroundColor = style.bg;
            messageBox.style.borderLeftColor = style.border;
            messageBox.classList.add('active');
            
            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }
            
            messageTimeout = setTimeout(() => {
                hideMessageBox();
            }, 10000);
        }
        
        function hideMessageBox() {
            messageBox.classList.remove('active');
            if (messageTimeout) {
                clearTimeout(messageTimeout);
                messageTimeout = null;
            }
        }

        if (machineNameInput.value.trim()) {
            joinMachineRoom();
        }
    </script>
</body>
</html>