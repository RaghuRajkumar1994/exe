<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Production Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .container { max-width: 1200px; margin: auto; }
        /* Grid for chart and totals table */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (min-width: 900px) {
            .dashboard-grid.analytics-section {
                grid-template-columns: 2fr 1fr; /* Chart 2/3, Totals 1/3 on desktop */
            }
        }
        .card { 
            border: none; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.05); background-color: white; overflow-x: auto;
        }
        th, td { white-space: nowrap; }
        #log-table th { background-color: #10B981; color: white; position: sticky; top: 0; }
        #totals-table th { background-color: #3B82F6; }
        #log-table tr:hover { background-color: #f0fdf4; }
        
        .upload-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            align-items: start;
        }
        @media (min-width: 600px) {
            .upload-form-grid {
                grid-template-columns: 2fr 1.5fr 1fr;
            }
        }
        
        /* === NEW MESSAGE MODAL STYLES === */
        #message-trigger {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1010; /* Higher than modal */
            cursor: pointer;
            transition: all 0.2s;
        }
        #message-trigger:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(139, 92, 246, 0.4);
        }

        #message-modal {
            position: fixed;
            bottom: 100px; /* Position above the trigger button */
            right: 30px;
            z-index: 1000;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 300px;
            display: none; /* Controlled by JS */
            flex-direction: column;
            gap: 10px;
            transform-origin: bottom right;
            animation: fadeInScale 0.2s ease-out;
        }
        
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
        }
        /* ================================ */
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">üõ†Ô∏è Live Production Dashboard</h1>

        <div id="message-modal">
            <div class="modal-header">
                <h3 class="text-lg font-bold text-purple-700">Send Live Message</h3>
                <button class="modal-close text-gray-500 hover:text-gray-800" onclick="toggleMessageModal(false)">√ó</button>
            </div>
            
            <div>
                <label for="modal-target-machine" class="block text-xs font-medium text-gray-600 mb-1">Target Machine:</label>
                <input type="text" id="modal-target-machine" placeholder="W_CUT_01" required 
                       class="w-full p-2 border border-gray-300 rounded-md text-sm uppercase focus:ring-purple-500 focus:border-purple-500">
            </div>
            
            <div>
                <label for="modal-message-text" class="block text-xs font-medium text-gray-600 mb-1">Message Text:</label>
                <textarea id="modal-message-text" rows="3" placeholder="Hurry up! Need P-101 completed." required
                          class="w-full p-2 border border-gray-300 rounded-md text-sm focus:ring-purple-500 focus:border-purple-500"></textarea>
            </div>
            
            <button onclick="sendMessageFromModal()" 
                    class="w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-150 shadow-md">
                Send Message
            </button>
            
            <p id="message-status" class="text-xs font-medium text-center mt-2 hidden"></p>
        </div>
        <div id="message-trigger" onclick="toggleMessageModal(true)" 
             class="bg-purple-600 text-white p-4 rounded-full shadow-xl">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
        </div>
        
        <div class="card mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-indigo-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/></svg>
                Distribute Plan Sheet (Excel)
            </h2>
            <form id="plan-upload-form" action="/upload_plan" method="POST" enctype="multipart/form-data" class="upload-form-grid">
                <div>
                    <label for="plan-sheet" class="block text-sm font-medium text-gray-600 mb-1">Select Excel Plan Sheet:</label>
                    <input type="file" id="plan-sheet" name="plan_sheet" accept=".xlsx,.xls" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="target-machine" class="block text-sm font-medium text-gray-600 mb-1">Target Machine:</label>
                    <input type="text" id="target-machine" name="target_machine" placeholder="e.g., W_CUT_01" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 uppercase">
                    <p class="text-xs text-gray-500 mt-1">Machine name must match worker's input.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1 invisible">Placeholder</label> 
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                        Upload & Send Plan
                    </button>
                </div>
            </form>
            <p id="upload-status" class="mt-4 text-sm font-medium text-center"></p>
        </div>

        <div class="controls flex flex-wrap justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-md">
            <div class="flex items-center space-x-4">
                <label for="date-filter" class="font-medium text-gray-700">Filter Date:</label>
                <input type="date" id="date-filter" class="p-2 border border-gray-300 rounded-lg text-base">
            </div>
            <div id="total-submissions" class="text-lg font-bold text-gray-800">Total Entries Displayed: 0</div>
            <button id="export-button" onclick="exportData()" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-150 shadow-md">
                Export All Data (CSV)
            </button>
        </div>
        
        <div class="dashboard-grid analytics-section">
            <div class="card chart-card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Quantity by Machine</h2>
                <div style="height: 300px;"><canvas id="machine-qty-chart"></canvas></div>
            </div>

            <div class="card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Summary Totals</h2>
                <table id="totals-table" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-medium uppercase tracking-wider text-white bg-blue-500 rounded-t-lg">Metric</th>
                            <th class="py-3 px-4 text-left text-xs font-medium uppercase tracking-wider text-white bg-blue-500 rounded-t-lg">Total</th>
                        </tr>
                    </thead>
                    <tbody id="totals-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="2" class="px-4 py-4 text-sm text-gray-500">No Data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card mt-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Submission Details</h2>
            <div class="overflow-x-auto">
                <table id="log-table" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-medium uppercase tracking-wider text-white">Time</th>
                            <th class="py-3 px-4 text-left text-xs font-medium uppercase tracking-wider text-white">Shift</th>
                            <th class="py-3 px-4 text-left text-xs font-medium uppercase tracking-wider text-white">Worker</th>
                            <th class="py-3 px-4 text-left text-xs font-medium uppercase tracking-wider text-white">Machine</th>
                            <th class="py-3 px-4 text-left text-xs font-medium uppercase tracking-wider text-white">FG Part No</th>
                            <th class="py-3 px-4 text-left text-xs font-medium uppercase tracking-wider text-white">Cable ID</th>
                            <th class="py-3 px-4 text-left text-xs font-medium uppercase tracking-wider text-white">Qty</th>
                            <th class="py-3 px-4 text-left text-xs font-medium uppercase tracking-wider text-white">Length</th>
                            <th class="py-3 px-4 text-left text-xs font-medium uppercase tracking-wider text-white">QTY PRODUCED HOURS</th>
                        </tr>
                    </thead>
                    <tbody id="log-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="9" class="px-4 py-4 text-sm text-gray-500">Select a date or submit new production data.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <script>
        const socket = io();
        const logTableBody = document.getElementById('log-table-body');
        const totalsTableBody = document.getElementById('totals-table-body');
        const totalSubmissionsElement = document.getElementById('total-submissions');
        const dateFilter = document.getElementById('date-filter');
        const uploadStatusElement = document.getElementById('upload-status');
        const planUploadForm = document.getElementById('plan-upload-form');
        const messageModal = document.getElementById('message-modal');
        const modalMachineInput = document.getElementById('modal-target-machine');
        const modalMessageTextarea = document.getElementById('modal-message-text');
        const messageStatusElement = document.getElementById('message-status');
        
        let machineQtyChart = null; 

        // --- File Upload Handler ---
        planUploadForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const targetMachineInput = document.getElementById('target-machine');
            targetMachineInput.value = targetMachineInput.value.trim().toUpperCase(); 

            uploadStatusElement.textContent = 'Uploading and processing file...';
            uploadStatusElement.className = 'mt-4 text-sm font-medium text-center text-blue-600';
            
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/upload_plan', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.text();
                
                if (response.ok) {
                    uploadStatusElement.textContent = result;
                    uploadStatusElement.className = 'mt-4 text-sm font-medium text-center text-green-600';
                } else {
                    uploadStatusElement.textContent = `Upload failed: ${result}`;
                    uploadStatusElement.className = 'mt-4 text-sm font-medium text-center text-red-600';
                }

            } catch (error) {
                uploadStatusElement.textContent = `A network error occurred: ${error.message}`;
                uploadStatusElement.className = 'mt-4 text-sm font-medium text-center text-red-600';
            }
            
            document.getElementById('plan-sheet').value = '';
        });

        // --- NEW: Toggle Modal Visibility ---
        function toggleMessageModal(show) {
            messageModal.style.display = show ? 'flex' : 'none';
            if (show) {
                modalMachineInput.focus();
                // Clear status when opening
                showMessageStatus('', ''); 
            }
        }
        
        // --- NEW: Send Message Function (called from modal button) ---
        function sendMessageFromModal() {
            const machineName = modalMachineInput.value.trim().toUpperCase();
            const messageText = modalMessageTextarea.value.trim();

            if (!machineName) {
                showMessageStatus('Error: Please enter a Target Machine Name.', 'text-red-600');
                return;
            }
            if (!messageText) {
                showMessageStatus('Error: Message text cannot be empty.', 'text-red-600');
                return;
            }

            showMessageStatus(`Sending message to ${machineName}...`, 'text-blue-600');

            socket.emit('send_message_to_machine', { 
                machineName: machineName, 
                message: messageText, 
                sender: 'Dashboard'
            });

            // Clear the text area after sending
            modalMessageTextarea.value = '';
            // Keep modal open to show status
        }
        
        // --- Utility to show message status inside the modal ---
        function showMessageStatus(text, colorClass) {
            clearTimeout(messageStatusElement.timer);
            messageStatusElement.textContent = text;
            messageStatusElement.className = `text-xs font-medium text-center mt-2 ${colorClass}`;
            messageStatusElement.classList.remove('hidden');
            
            if (text) {
                 messageStatusElement.timer = setTimeout(() => { 
                    messageStatusElement.classList.add('hidden'); 
                 }, 5000);
            }
        }

        // Generates consistent colors for the bar chart
        function generateColors(count) {
            const colors = [
                'rgba(16, 185, 129, 0.8)', 
                'rgba(99, 102, 241, 0.8)',
                'rgba(245, 158, 11, 0.8)',
                'rgba(239, 68, 68, 0.8)', 
                'rgba(139, 92, 246, 0.8)', 
                'rgba(249, 115, 22, 0.8)', 
                'rgba(6, 182, 212, 0.8)',  
                'rgba(75, 85, 99, 0.8)',
            ];
            return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
        }

        // Renders or updates the Chart.js visualization
        function updateChart(chartData) {
            const labels = chartData.map(item => item.machine);
            const quantities = chartData.map(item => item.total_qty);
            const backgroundColors = generateColors(labels.length);

            if (machineQtyChart) {
                machineQtyChart.destroy();
            }
            
            if (labels.length === 0) { return; }

            const ctx = document.getElementById('machine-qty-chart').getContext('2d');
            machineQtyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Qty Produced',
                        data: quantities,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(c => c.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantity (Units)'
                            }
                        },
                        x: {
                             title: {
                                display: true,
                                text: 'Machine Name'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
        }
        
        // Updates the summary table for Qty, Length, and Hours
        function updateTotalsTable(logEntries) {
            let totalQty = 0;
            let totalLength = 0;
            let totalProducedHours = 0;
            
            logEntries.forEach(entry => {
                totalQty += parseInt(entry.produced_qty || 0);
                totalLength += parseFloat(entry.produced_length || 0);
                totalProducedHours += parseFloat(entry.qty_produced_hours || 0);
            });
            
            totalsTableBody.innerHTML = '';
            
            const totals = [
                { metric: 'Total Qty', value: totalQty.toFixed(0) },
                { metric: 'Total Length', value: totalLength.toFixed(1) + ' M/F' },
                { metric: 'Total Qty Produced Hours', value: totalProducedHours.toFixed(1) + ' Hrs' }
            ];
            
            if (logEntries.length === 0) {
                totalsTableBody.innerHTML = '<tr><td colspan="2" class="px-4 py-4 text-sm text-gray-500">No data available for totals.</td></tr>';
                return;
            }

            totals.forEach(total => {
                const row = totalsTableBody.insertRow();
                row.className = "hover:bg-gray-50";
                row.insertCell().textContent = total.metric;
                
                const valueCell = row.insertCell();
                valueCell.className = "font-semibold";
                valueCell.textContent = total.value;
            });
        }

        // Main function to update the dashboard display
        function updateDisplay(data) {
            logTableBody.innerHTML = ''; 
            const logEntries = data.log || [];
            const chartData = data.chart_data || [];
            
            totalSubmissionsElement.textContent = `Total Entries Displayed: ${logEntries.length}`;

            // --- 1. Update Chart ---
            updateChart(chartData);

            // --- 2. Update Totals Table ---
            updateTotalsTable(logEntries);

            // --- 3. Update Detail Log Table ---
            if (logEntries.length === 0) {
                 logTableBody.innerHTML = '<tr><td colspan="9" class="px-4 py-4 text-sm text-gray-500">No production data found for this date.</td></tr>'; 
                 return;
            }

            logEntries.forEach((entry) => {
                const row = logTableBody.insertRow();
                row.className = "hover:bg-gray-50";
                
                row.insertCell().textContent = entry.time_display; 
                row.insertCell().textContent = entry.shift; 
                row.insertCell().textContent = entry.worker_name;
                row.insertCell().textContent = entry.machine_name;
                row.insertCell().textContent = entry.fg_part_no;
                row.insertCell().textContent = entry.cable_id;
                row.insertCell().textContent = entry.produced_qty;
                row.insertCell().textContent = entry.produced_length;
                row.insertCell().textContent = entry.qty_produced_hours; 
            });
        }
        
        // Function to request data for a specific date (used by the filter)
        function requestDataForDate() {
            const selectedDate = dateFilter.value;
            socket.emit('request_date_data', { date: selectedDate });
        }
        
        // Function to export all data (links directly to the server's /export route)
        function exportData() {
            window.location.href = '/export';
        }

        // Set the default date filter to today and attach listener
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            dateFilter.value = today;
            
            dateFilter.addEventListener('change', requestDataForDate);
            
            // Request initial data when the dashboard loads
            requestDataForDate();
        });

        // --- Socket.IO Event Listener for Dashboard Data ---
        socket.on('update_dashboard', (data) => {
            updateDisplay(data);
        });

        // --- Socket.IO Listener for Message Confirmation ---
        socket.on('message_sent_confirm', (data) => {
             if (data.success) {
                 showMessageStatus(`Message sent to ${data.machineName}.`, 'text-green-600');
             } else {
                 showMessageStatus(`Failed to send message to ${data.machineName}: ${data.reason}`, 'text-red-600');
             }
        });

    </script>
</body>
</html>